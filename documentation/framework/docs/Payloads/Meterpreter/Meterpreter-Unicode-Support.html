<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Metasploit Versions 4,5" />
  <title>Unicode Support</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="../../styles.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,300;1,400&display=swap" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>

<div id="main-outer-box">

<nav class="right">
  <ul>
    <li style="display: inline;"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/documentation/modules" target="_blank">Module Docs</a></li>
    <li style="display: inline;"><a href="https://rapid7.github.io/metasploit-framework/api/" target="_blank">API</a></li>
    <li style="display: inline;"><a href="https://github.com/rapid7/metasploit-framework" target="_blank">Metasploit GitHub</a></li>
     <li style="display: inline;"><a href="../../search.html">Search</a></li>
  </ul>
</nav>

<div id="my-header">
  <a href="{{path-to-index}}">Metasploit Framework</a>
</div>

<div id="trunk-box">

<div id="nav-box">
<p>Contents:</p>
<ul>
<li>Getting-Started/
<ul>
<li><a href="../.././Getting-Started/Installing-Metasploit.html">Installing Metasploit</a></li>
<li><a href="../.././Getting-Started/setting-up-metasploit-dev-enviroment.html">Setting up a Metasploit Developer Environment</a></li>
<li>Contributing/
<ul>
<li><a href="../.././Getting-Started/Contributing/Code-Of-Conduct.html">Contributor Code of Conduct</a></li>
<li><a href="../.././Getting-Started/Contributing/Contributing-to-Metasploit.html">Contributing to Metasploit</a></li>
<li><a href="../.././Getting-Started/Contributing/Guidelines-for-Accepting-Modules-and-Enhancements.html">Guidelines for accepting modules and enhancements</a></li>
<li><a href="../.././Getting-Started/Contributing/Adding-Release-Notes-to-PRs.html">Adding release notes to PRs</a></li>
<li><a href="../.././Getting-Started/Contributing/Landing-Pull-Requests.html">Landing pull requests</a></li>
<li><a href="../.././Getting-Started/Contributing/Keeping-in-sync-with-rapid7-master.html">Keep in sync with master</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-add-and-update-gems-in-metasploit-framework.html">How to add and update gems</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-deprecate-a-Metasploit-module.html">How to deprecate a Metasploit module</a></li>
<li><a href="../.././Getting-Started/Contributing/Rolling-back-merges.html">Roll back merges</a></li>
<li><a href="../.././Getting-Started/Contributing/Style-Tips.html">Style Tips</a></li>
<li><a href="../.././Getting-Started/Contributing/Reporting-a-Bug.html">Metasploit Bug Reporting</a></li>
<li><a href="../.././Getting-Started/Contributing/markdown-cheat-sheet.html">Markdown Cheat Sheet</a></li>
</ul></li>
<li>Kali-Linux/
<ul>
<li><a href="../.././Getting-Started/Kali-Linux/How-to-get-Oracle-Support-working-with-Kali-Linux.html">Use Oracle support with Kali Linux</a></li>
</ul></li>
<li><a href="../.././Getting-Started/Contact.html">Contact</a></li>
</ul></li>
<li>Internals/
<ul>
<li><a href="../.././Internals/workspaces.html">Workspaces</a></li>
</ul></li>
<li>Modules/
<ul>
<li><a href="../.././Modules/How-to-use-a-Metasploit-module-appropriately.html">Properly use a module</a></li>
<li><a href="../.././Modules/Module-Documentation.html">Module documentation</a></li>
<li><a href="../.././Modules/Handling-Module-Failures-with-fail_with.html">Handing modules failures with <code>fail_with</code></a></li>
<li><a href="../.././Modules/Running-Private-Modules.html">Run private modules</a></li>
<li><a href="../.././Modules/How-to-do-reporting-or-store-data-in-module-development.html">How to do reporting and store data during module development</a></li>
<li><a href="../.././Modules/Using-ReflectiveDll-Injection.html">Using the ReflectiveDll loader in a Metasploit module</a></li>
<li>Write-Modules/
<ul>
<li><a href="../.././Modules/Write-Modules/How-to-write-a-module-using-HttpServer-and-HttpClient.html">How to write a module using HTTPServer and HTTPClient</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-Metasploit-Modules.html">Writing External Metasploit Modules</a></li>
<li><a href="../.././Modules/Write-Modules/get-started-writing-auxillary-module.html">Get started with writing an auxiliary module</a></li>
<li><a href="../.././Modules/Write-Modules/How-to-write-a-HTTP-LoginScanner-Module.html">How to write a HTTP LoginScanner Module</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-Python-Modules.html">Writing Python Modules for Metasploit</a></li>
<li><a href="../.././Modules/Write-Modules/get-started-writing-post-module.html">Get started with writing a post module</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-GoLang-Modules.html">Writing external GoLang modules</a></li>
<li><a href="../.././Modules/Write-Modules/login-scanner.html">Create a Login Scanner Module</a></li>
<li><a href="../.././Modules/Write-Modules/http-login-scanner.html">How to write a HTTP LoginScanner Module</a></li>
</ul></li>
<li><a href="../.././Modules/module-reference-identifiers.html">Reference Identifiers</a></li>
</ul></li>
<li>Exploits/
<ul>
<li><a href="../.././Exploits/use-exploits.html">Use exploits</a></li>
<li><a href="../.././Exploits/Information-About-Unmet-Browser-Exploit-Requirements.html">Unmet browser exploit requirements</a></li>
<li><a href="../.././Exploits/How-to-use-Powershell-in-an-exploit.html">Add PowerShell mixin to an exploit</a></li>
<li><a href="../.././Exploits/How-to-clean-up-files-using-FileDropper.html">How to clean up files using FileDropper</a></li>
<li><a href="../.././Exploits/How-to-use-PhpEXE-to-exploit-an-arbitrary-file-upload-bug.html">PhpEXE arbitrary file upload</a></li>
<li><a href="../.././Exploits/How-to-use-Railgun-for-Windows-post-exploitation.html">Use Railgun for Windows</a></li>
<li><a href="../.././Exploits/How-to-use-command-stagers.html">Use command stagers</a></li>
<li><a href="../.././Exploits/exploit-ranking.html">Exploit Ranking</a></li>
<li>Write-Exploits/
<ul>
<li><a href="../.././Exploits/Write-Exploits/writing-exploits.html">Get Started Writing an Exploit</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows.html">Write a privilege attack with WbemExec</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit.html">How to use the FILEFORMAT mixin</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-write-a-browser-exploit-using-HttpServer.html">How to write a browser exploit using HTTP Server</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-write-a-browser-exploit-using-BrowserExploitServer.html">Write a browser exploit with BrowserExploitServer</a></li>
</ul></li>
</ul></li>
<li>Payloads/
<ul>
<li><a href="../.././Payloads/how-payloads-work.html">How Payloads Work</a></li>
<li><a href="../.././Payloads/payload-debugging.html">Payload Debugging</a></li>
<li><a href="../.././Payloads/Payload-UUID.html">Payload UUID</a></li>
<li>Meterpreter/
<ul>
<li><a href="about-meterpreter.html">About Meterpreter</a></li>
<li><a href="meterpreter-configuration.html">Meterpreter Configuration</a></li>
<li><a href="transport-control.html">Transport Control</a></li>
<li><a href="Meterpreter-Reliable-Network-Communication.html">Reliable Network Communication</a></li>
<li><strong>Unicode Support</strong></li>
<li><a href="Meterpreter-HTTP-Communication.html">Meterpreter HTTP communication</a></li>
<li><a href="Meterpreter-Sleep-Control.html">Sleep Control</a></li>
<li><a href="Meterpreter-Paranoid-Mode.html">Paranoid Mode</a></li>
<li><a href="The-ins-and-outs-of-HTTP-and-HTTPS-communications-in-Meterpreter-and-Metasploit-Stagers.html">HTTP and HTTPS communication</a></li>
<li><a href="Python-Extension.html">Python Extension</a></li>
</ul></li>
<li>msfvenom/
<ul>
<li><a href="../.././Payloads/msfvenom/How-to-use-msfvenom.html">How to use msfvenom</a></li>
</ul></li>
<li>Shell/
<ul>
<li><a href="../.././Payloads/Shell/How-to-use-a-reverse-shell-in-Metasploit.html">How to use a reverse shell</a></li>
</ul></li>
</ul></li>
<li>Utilities/
<ul>
<li><a href="../.././Utilities/complier-windows-c.html">How to use Metasploit Framework Compiler Windows to compile C code</a></li>
<li><a href="../.././Utilities/oracle-support-kali-linux.html">Oracle Support working with Kali Linux</a></li>
<li><a href="../.././Utilities/How-to-zip-files-with-Msf-Util-EXE.to_zip.html">How to zip files with Msf::Util::EXE.to_zip</a></li>
<li><a href="../.././Utilities/How-to-use-the-Msf-Exploit-Remote-Tcp-mixin.html">How to use the Msf::Exploit::Remote::Tcp mixin</a></li>
</ul></li>
<li>Evasion-and-Obfuscation/
<ul>
<li><a href="../.././Evasion-and-Obfuscation/obfuscation-crandomizer.html">CRandomizer</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-obfuscate-JavaScript-in-Metasploit.html">Obfuscate JavaScript</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-use-Metasploit-Framework-Obfuscation-CRandomizer.html">How to use CRandomizer</a></li>
</ul></li>
<li>API/
<ul>
<li><a href="../.././API/Metasploit-Web-Service.html">Metasploit web service</a></li>
<li><a href="../.././API/Metasploit-as-a-service.html">Metasploit as a service</a></li>
</ul></li>
<li>Debugging/
<ul>
<li><a href="../.././Debugging/How-to-log-in-Metasploit.html">Log Files in Metasploit</a></li>
<li><a href="../.././Debugging/Why-CVE-is-not-available.html">Why is a CVE Not Available?</a></li>
</ul></li>
<li><a href="../.././external-resources.html">Community Resources</a></li>
</ul>

</div>

<div id="article-box">

<div id="header-nav-bar">
<div><a href="Meterpreter-Reliable-Network-Communication.html">←prev</a></div><div class="nav-bar-push"><a href="Meterpreter-HTTP-Communication.html">next→</a></div>
</div>

<div id="article-content">
<header id="title-block-header">
<h1 class="title">Unicode Support</h1>
<p class="author">Metasploit Versions 4,5</p>
</header>
<p>Until recently (April 2015), Meterpreter always sent string data in whatever the system encoding happened to be. With the TLV protocol, the TLV_TYPE_STRING was treated roughly as a plain C byte array, with no real expectations as to how the data should be decoded on the Meterpreter or Metasploit framework sides. As a result, type confusion occurred between different locales on remote machines and the local console. To avoid corrupting the terminal due to mistaken character encoding interpretations, Metasploit framework implements Unicode filter that converts any possibly unprintable characters into hex strings. While this allows a sufficiently-advanced human to eyeball a string for meaning, it makes dealing with Unicode strings awkward.</p>
<p>To solve the problem, TLV_TYPE_STRING has been retroactively declared to mean UTF-8 encoding only. All Meterpreter implementations should send UTF-8 strings and expect them in requests. On Windows systems, this means that Meterpreter needs to convert to and from Windows’ UTF-16LE implementation.</p>
<p>So far, the Filesystem operations on all Meterpreters have been converted to expect a and send UTF-8 strings. Only the PHP meterpreter on Windows lacks Unicode support, due to limitations in PHP itself. All new TLVs should send and receive UTF-8. There is still functionality, that needs conversion beyond the Filesystem APIs, and these can be loosely discovered with a command like <code>grep -R A\( *</code> to find all ASCII variants of functions called by meterpreter.</p>
<p>In the Windows C meterpreter, there are a couple of helper functions to simplify the conversion work:</p>
<pre><code>wchar_t *utf8_to_wchar(const char *in);

char *wchar_to_utf8(const wchar_t *in);</code></pre>
<p>These functions both allocate a new string as their return value, so the strings should be freed after use by the caller. Here is an example of a function expanding a path and performing the conversion to and from UTF-8:</p>
<pre><code>char * fs_expand_path(const char *regular)
{
        wchar_t expanded_path[FS_MAX_PATH];
        wchar_t *regular_w;

        regular_w = utf8_to_wchar(regular);
        if (regular_w == NULL) {
                return NULL;
        }

        if (ExpandEnvironmentStringsW(regular_w, expanded_path, FS_MAX_PATH) == 0) {
                free(regular_w);
                return NULL;
        }

        free(regular_w);
        return wchar_to_utf8(expanded_path);
}</code></pre>
<p>Unicode support in Metasploit framework today is enabled by default on Linux/Unix systems, since most modern terminal emulators have no trouble displaying the characters. However, on Windows, most native terminal emulators ironically have trouble working with more than one language at once, due to historical code page support. So, for Windows, Unicode characters are still filtered by default. Setting EnableUnicodeEncoding to false will allow the native characters to be emitted by the Metasploit console.</p>

</div> <!-- article-content -->

<div id="footer-nav-bar">
<div><a href="Meterpreter-Reliable-Network-Communication.html">←prev</a></div><div class="nav-bar-push"><a href="Meterpreter-HTTP-Communication.html">next→</a></div>
</div>

</div> <!-- article-box -->

</div> <!-- trunk-box -->

<div id="my-footer">
<p>Copyright <a href="https://metasploit.com/">Metasploit</a>, 2020</p>
<p><a href="https://join.slack.com/t/metasploit/shared_invite/enQtOTMxMjg5ODY3NDYxLTYyZTVlNDM1ZTI3ZGQ0YTQ0NmI1YjgxMGEwYzFhOWNiZWQ4NDNmNTE1MWNiYzJhMzgwMGY0ZWY2NTY0MjA2M2I">Slack team - metasploit.slack.com</a></p>
<p><a href="https://twitter.com/metasploit">#twitter handle - @metasploit</a></p>
<p><a href="mailto:msfdev@metasploit.com">development questions - msfdev [ @ ] metasploit.com</a></p>
<p> This site is built with <a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>, <a href="https://lunrjs.com/">Lunr</a>, and <a href="https://github.com/BLE-LTER/Lunr-Index-and-Search-for-Static-Sites">BLE-LTER</a>.<br/>
<a href="Meterpreter-Unicode-Support.md">Pandoc-Markdown source for this page</a><br/>
(Docs processed by
<a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>.)
</div> <!-- my-footer -->

</div> <!-- main-outer-box -->

</body>
</html>
