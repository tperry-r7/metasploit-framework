<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Metasploit Versions 4,5" />
  <title>HTTP and HTTPS communication</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="../../styles.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,300;1,400&display=swap" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>

<div id="main-outer-box">

<nav class="right">
  <ul>
    <li style="display: inline;"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/documentation/modules" target="_blank">Module Docs</a></li>
    <li style="display: inline;"><a href="https://rapid7.github.io/metasploit-framework/api/" target="_blank">API</a></li>
    <li style="display: inline;"><a href="https://github.com/rapid7/metasploit-framework" target="_blank">Metasploit GitHub</a></li>
     <li style="display: inline;"><a href="../../search.html">Search</a></li>
  </ul>
</nav>

<div id="my-header">
  <a href="{{path-to-index}}">Metasploit Framework</a>
</div>

<div id="trunk-box">

<div id="nav-box">
<p>Contents:</p>
<ul>
<li>Getting-Started/
<ul>
<li><a href="../.././Getting-Started/Installing-Metasploit.html">Installing Metasploit</a></li>
<li><a href="../.././Getting-Started/setting-up-metasploit-dev-enviroment.html">Setting up a Metasploit Developer Environment</a></li>
<li>Contributing/
<ul>
<li><a href="../.././Getting-Started/Contributing/Code-Of-Conduct.html">Contributor Code of Conduct</a></li>
<li><a href="../.././Getting-Started/Contributing/Contributing-to-Metasploit.html">Contributing to Metasploit</a></li>
<li><a href="../.././Getting-Started/Contributing/Guidelines-for-Accepting-Modules-and-Enhancements.html">Guidelines for accepting modules and enhancements</a></li>
<li><a href="../.././Getting-Started/Contributing/Adding-Release-Notes-to-PRs.html">Adding release notes to PRs</a></li>
<li><a href="../.././Getting-Started/Contributing/Landing-Pull-Requests.html">Landing pull requests</a></li>
<li><a href="../.././Getting-Started/Contributing/Keeping-in-sync-with-rapid7-master.html">Keep in sync with master</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-add-and-update-gems-in-metasploit-framework.html">How to add and update gems</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-deprecate-a-Metasploit-module.html">How to deprecate a Metasploit module</a></li>
<li><a href="../.././Getting-Started/Contributing/Rolling-back-merges.html">Roll back merges</a></li>
<li><a href="../.././Getting-Started/Contributing/Style-Tips.html">Style Tips</a></li>
<li><a href="../.././Getting-Started/Contributing/Reporting-a-Bug.html">Metasploit Bug Reporting</a></li>
<li><a href="../.././Getting-Started/Contributing/markdown-cheat-sheet.html">Markdown Cheat Sheet</a></li>
</ul></li>
<li>Kali-Linux/
<ul>
<li><a href="../.././Getting-Started/Kali-Linux/How-to-get-Oracle-Support-working-with-Kali-Linux.html">Use Oracle support with Kali Linux</a></li>
</ul></li>
<li><a href="../.././Getting-Started/Contact.html">Contact</a></li>
</ul></li>
<li>Internals/
<ul>
<li><a href="../.././Internals/workspaces.html">Workspaces</a></li>
</ul></li>
<li>Modules/
<ul>
<li><a href="../.././Modules/How-to-use-a-Metasploit-module-appropriately.html">Properly use a module</a></li>
<li><a href="../.././Modules/Module-Documentation.html">Module documentation</a></li>
<li><a href="../.././Modules/Handling-Module-Failures-with-fail_with.html">Handing modules failures with <code>fail_with</code></a></li>
<li><a href="../.././Modules/Running-Private-Modules.html">Run private modules</a></li>
<li><a href="../.././Modules/How-to-do-reporting-or-store-data-in-module-development.html">How to do reporting and store data during module development</a></li>
<li><a href="../.././Modules/Using-ReflectiveDll-Injection.html">Using the ReflectiveDll loader in a Metasploit module</a></li>
<li>Write-Modules/
<ul>
<li><a href="../.././Modules/Write-Modules/How-to-write-a-module-using-HttpServer-and-HttpClient.html">How to write a module using HTTPServer and HTTPClient</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-Metasploit-Modules.html">Writing External Metasploit Modules</a></li>
<li><a href="../.././Modules/Write-Modules/get-started-writing-auxillary-module.html">Get started with writing an auxiliary module</a></li>
<li><a href="../.././Modules/Write-Modules/How-to-write-a-HTTP-LoginScanner-Module.html">How to write a HTTP LoginScanner Module</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-Python-Modules.html">Writing Python Modules for Metasploit</a></li>
<li><a href="../.././Modules/Write-Modules/get-started-writing-post-module.html">Get started with writing a post module</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-GoLang-Modules.html">Writing external GoLang modules</a></li>
<li><a href="../.././Modules/Write-Modules/login-scanner.html">Create a Login Scanner Module</a></li>
<li><a href="../.././Modules/Write-Modules/http-login-scanner.html">How to write a HTTP LoginScanner Module</a></li>
</ul></li>
<li><a href="../.././Modules/module-reference-identifiers.html">Reference Identifiers</a></li>
</ul></li>
<li>Exploits/
<ul>
<li><a href="../.././Exploits/use-exploits.html">Use exploits</a></li>
<li><a href="../.././Exploits/Information-About-Unmet-Browser-Exploit-Requirements.html">Unmet browser exploit requirements</a></li>
<li><a href="../.././Exploits/How-to-use-Powershell-in-an-exploit.html">Add PowerShell mixin to an exploit</a></li>
<li><a href="../.././Exploits/How-to-clean-up-files-using-FileDropper.html">How to clean up files using FileDropper</a></li>
<li><a href="../.././Exploits/How-to-use-PhpEXE-to-exploit-an-arbitrary-file-upload-bug.html">PhpEXE arbitrary file upload</a></li>
<li><a href="../.././Exploits/How-to-use-Railgun-for-Windows-post-exploitation.html">Use Railgun for Windows</a></li>
<li><a href="../.././Exploits/How-to-use-command-stagers.html">Use command stagers</a></li>
<li><a href="../.././Exploits/exploit-ranking.html">Exploit Ranking</a></li>
<li>Write-Exploits/
<ul>
<li><a href="../.././Exploits/Write-Exploits/writing-exploits.html">Get Started Writing an Exploit</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows.html">Write a privilege attack with WbemExec</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit.html">How to use the FILEFORMAT mixin</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-write-a-browser-exploit-using-HttpServer.html">How to write a browser exploit using HTTP Server</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-write-a-browser-exploit-using-BrowserExploitServer.html">Write a browser exploit with BrowserExploitServer</a></li>
</ul></li>
</ul></li>
<li>Payloads/
<ul>
<li><a href="../.././Payloads/how-payloads-work.html">How Payloads Work</a></li>
<li><a href="../.././Payloads/payload-debugging.html">Payload Debugging</a></li>
<li><a href="../.././Payloads/Payload-UUID.html">Payload UUID</a></li>
<li>Meterpreter/
<ul>
<li><a href="about-meterpreter.html">About Meterpreter</a></li>
<li><a href="meterpreter-configuration.html">Meterpreter Configuration</a></li>
<li><a href="transport-control.html">Transport Control</a></li>
<li><a href="Meterpreter-Reliable-Network-Communication.html">Reliable Network Communication</a></li>
<li><a href="Meterpreter-Unicode-Support.html">Unicode Support</a></li>
<li><a href="Meterpreter-HTTP-Communication.html">Meterpreter HTTP communication</a></li>
<li><a href="Meterpreter-Sleep-Control.html">Sleep Control</a></li>
<li><a href="Meterpreter-Paranoid-Mode.html">Paranoid Mode</a></li>
<li><strong>HTTP and HTTPS communication</strong></li>
<li><a href="Python-Extension.html">Python Extension</a></li>
</ul></li>
<li>msfvenom/
<ul>
<li><a href="../.././Payloads/msfvenom/How-to-use-msfvenom.html">How to use msfvenom</a></li>
</ul></li>
<li>Shell/
<ul>
<li><a href="../.././Payloads/Shell/How-to-use-a-reverse-shell-in-Metasploit.html">How to use a reverse shell</a></li>
</ul></li>
</ul></li>
<li>Utilities/
<ul>
<li><a href="../.././Utilities/complier-windows-c.html">How to use Metasploit Framework Compiler Windows to compile C code</a></li>
<li><a href="../.././Utilities/oracle-support-kali-linux.html">Oracle Support working with Kali Linux</a></li>
<li><a href="../.././Utilities/How-to-zip-files-with-Msf-Util-EXE.to_zip.html">How to zip files with Msf::Util::EXE.to_zip</a></li>
<li><a href="../.././Utilities/How-to-use-the-Msf-Exploit-Remote-Tcp-mixin.html">How to use the Msf::Exploit::Remote::Tcp mixin</a></li>
</ul></li>
<li>Evasion-and-Obfuscation/
<ul>
<li><a href="../.././Evasion-and-Obfuscation/obfuscation-crandomizer.html">CRandomizer</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-obfuscate-JavaScript-in-Metasploit.html">Obfuscate JavaScript</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-use-Metasploit-Framework-Obfuscation-CRandomizer.html">How to use CRandomizer</a></li>
</ul></li>
<li>API/
<ul>
<li><a href="../.././API/Metasploit-Web-Service.html">Metasploit web service</a></li>
<li><a href="../.././API/Metasploit-as-a-service.html">Metasploit as a service</a></li>
</ul></li>
<li>Debugging/
<ul>
<li><a href="../.././Debugging/How-to-log-in-Metasploit.html">Log Files in Metasploit</a></li>
<li><a href="../.././Debugging/Why-CVE-is-not-available.html">Why is a CVE Not Available?</a></li>
</ul></li>
<li><a href="../.././external-resources.html">Community Resources</a></li>
</ul>

</div>

<div id="article-box">

<div id="header-nav-bar">
<div><a href="Meterpreter-Paranoid-Mode.html">←prev</a></div><div class="nav-bar-push"><a href="Python-Extension.html">next→</a></div>
</div>

<div id="article-content">
<header id="title-block-header">
<h1 class="title">HTTP and HTTPS communication</h1>
<p class="author">Metasploit Versions 4,5</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#windows-http-apis">Windows HTTP APIs</a></li>
<li><a href="#meterpreters-implementation">Meterpreter’s Implementation</a></li>
<li><a href="#metasploit-http-and-https-stagers">Metasploit HTTP and HTTPS Stagers</a></li>
<li><a href="#combining-stagers-with-meterpreter">Combining Stagers with Meterpreter</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</nav>
<p>Recent changes to HTTP and HTTPS communications in both Meterpreter and its stagers have caused new behaviours that have left some users confused. The aim of this post is to cover the changes that have been made, the rationale behind those changes, and the issues that come with them. By the end of this post, readers should have a clear understanding of the issues related to HTTP/S communications, and be able to diagnose and fix any issues that they might be having.</p>
<h2 id="windows-http-apis">Windows HTTP APIs</h2>
<p>The Windows API comes with two ways to talk via HTTP/S, they are [WinInet][] and [WinHTTP][]. The APIs are consumed in a similar fashion; many of the functions in each have the same interface, or are at least close enough to make a transition between the two rather trivial. However, there are some underlying differences that are important.</p>
<p>The [WinInet][] API was designed for use in desktop applications. It provides all the features required by applications to use HTTP/S while delegating much of the responsibilty of handling implementation detail to the underlying API and OS. This API can result in some user interface elements appearing if not handled correctly.</p>
<p>[WinInet][] comes with some limitations, one of which is that it’s close to impossible to do any kind of custom validation, parsing, or handling of SSL communications. One of the needs of Metasploit users is to be able to enable a [Paranoid Mode][] that forces Meterpreter to only talk with the appropriate endpoint. The goal is to prevent shells from being hijacked by unauthorised users. In order to do this, one of the things that was implemented was the verification of the SHA1 hash of the SSL certificate that Meterpreter reads from the server. If this hash doesn’t match the one that Meterpreter is configured with, Meterpreter will shut down. [WinInet][] doesn’t make this process possible without a <em>lot</em> of custom work.</p>
<p>For applications such as this, [WinHTTP][] is the “preferred” option as deemed by Microsoft. This API is designed to work under a service, and provides a greater number of ways to interact with communications made over HTTP/S. With this API it was trivial to implement the SHA1 hash verification and force Meterpreter to shut down when a MITM is detected.</p>
<p>For a full comparison of the feature differences, please see [this feature matrix][winhttp_wininet] on MSDN.</p>
<h2 id="meterpreters-implementation">Meterpreter’s Implementation</h2>
<p>Meterpreter now makes use of [WinHTTP][] by default so that the new features are accommodated, but unfortuanetly this doesn’t come for free. Behind the scenes, this API does not make any use of the current user’s Internet Explorer configuration settings, where the [WinInet][] API does. This means that if the current user has a proxy configured, extra code needs to be added to make use of the current Internet Explorer settings in [WinHTTP][]. Meterpreter has been modified to do this, however there is still one limitation that is in place.</p>
<p>As indicated in a <a href="https://web.archive.org/web/20150701090733/http://blogs.msdn.com/b/httpcontext/archive/2012/02/21/changes-in-winhttp-on-windows-7-and-onwards-wrto-http-1-0.aspx">blog post on MSDN</a>:</p>
<blockquote>
<p>WinHTTP strictly requires HTTP/1.1 compliance for keeping the connection alive and HTTP Keep-Alives are not supported in HTTP/1.0 protocol. HTTP Keep-Alive feature was introduced in the HTTP/1.1 protocol as per RFC 2616. The server or the proxy which expects the keep-alive should also implement the protocol correctly. WinHTTP on Windows 7, Windows 2008 R2 are strict in terms of security wrto protocol compliance. The ideal solution is to change the server/proxy to use the right protocol and be RFC compliant.</p>
</blockquote>
<p>What this means is that from Windows 7 and onwards, the underlying [WinHTTP][] implementation requires proper HTTP/1.1 support from any proxies that are used. If a proxy uses HTTP/1.0, such as Squid 2.7, and requires <code>Keep-Alive</code> support, such as NTLM authentication, then [WinHTTP][] will refuse to talk to it. Instead of downgrading, it will expect a purely RFC-compliant implementation, and instead will return a <code>407</code> error the client. This means that for Meterpreter to work, [WinHTTP][] can’t be used.</p>
<p>In order to avoid this issue, <a href="https://github.com/rapid7/metasploit-payloads/pull/5">extra work</a> has beeen done to force Meterpreter to fall back to [WinInet][] when this happens. Given that [WinInet][] doesn’t do certificate hash verification, this means that the user of Meterpreter loses the ability to use paranoid mode. It was decided that Meterpreter would not fallback to [WinInet][] if paranoid mode was enabled, as the intention of the user is clearly to avoid MITM.</p>
<p>To sum up, Meterpreter will use [WinHTTP][] where it can. If it can’t, it’ll fall back to [WinInet][] <em>unless</em> paranoid mode is enabled.</p>
<h2 id="metasploit-http-and-https-stagers">Metasploit HTTP and HTTPS Stagers</h2>
<p>Metasploit users have long since known about the <code>reverse_http</code> and <code>reverse_https</code> stagers, and have made good use of them over time. What many <em>don’t</em> know is that these stagers use the [WinInet][] API, which means that they don’t get SSL certificate validation (so no paranoid mode).</p>
<p>To provide support for paranoid mode directly inside the stager, ultimately preventing the download of Meterpreter <em>at all</em> in the case of MITM, new stagers were required. <code>reverse_winhttp</code> and <code>reverse_winhttps</code> are implementations of stagers that make use of [WinHTTP][], and in the latter case, provides support for paranoid mode. They do, however come with the same implicit limitation as Meterpreter itself in that they may not be able to provide proxy support thanks to the strict RFC compliance described in the previous section. The big difference here is that the stager does <em>not</em> have a fallback implementation like Meterpreter does, as this would make the stager way too big. Therefore, if an older proxy is in place that doesn’t confirm to HTTP/1.1, the stager will fail.</p>
<h2 id="combining-stagers-with-meterpreter">Combining Stagers with Meterpreter</h2>
<p>It’s important to note that the implementations of communications inside the stagers are completely separate to those inside Meterpreter. If you use <code>windows/meterpreter/reverse_https</code>, then the stager will use [WinInet][] and Meterpreter will use [WinHTTP][]. It isn’t possible to “hand over” communications from the stager to Meterpreter in this case, and it wouldn’t make sense anyway because HTTP/S is stateless. This is the most common set up because many people don’t realise that the <code>reverse_winhttp/s</code> payloads exist!</p>
<p>Prior to the <a href="https://github.com/rapid7/metasploit-payloads/pull/5">WinInet fallback</a> work, those people hitting the HTTP/1.0 proxy issue would find themselves with the following scenario:</p>
<ol type="1">
<li>They would exploit a Windows 7 (or later) target in some way, whether it be via a browser exploit, or through a social engineering attack.</li>
<li>The payload that was executed was <code>meterpreter/reverse_https</code>, and so the initial connection would come via [WinInet][].</li>
<li>[WinInet][] would successfully use the current user’s proxy configuration and the initial connection back to Metasploit would be successful.</li>
<li>The stager would download the second stage (<code>metsrv</code>), and reflectively load it so that Meterpreter could take over.</li>
<li>Meterpreter would attempt to connect again to Metasploit, this time using [WinHTTP][].</li>
<li>The proxy would return HTTP/1.0 responses, resulting in [WinHTTP][] refusing to function.</li>
<li>The Meterpreter session would be considered “dead” by Metasploit as a result of the lack of successful communications after staging.</li>
</ol>
<p>Examples of these issues are <a href="https://github.com/rapid7/metasploit-framework/issues/5462">this</a> and <a href="https://github.com/rapid7/metasploit-framework/issues/5626">this</a>. If you are seeing similar issues it’s because your current Meterpreter binaries don’t have the fallback option.</p>
<h2 id="conclusion">Conclusion</h2>
<p>HTTP/S communications in Windows is a hairy beast, and trying to cater for all cases proves to be quite tricky thanks to the limitations of some APIs, and the variable implementations of others. We’re still working to iron out all of issues, and so please log an issue if you stumble on an edge case that hasn’t yet been covered. Thank you for your patience!</p>
<p>[OJ][] / <span class="citation" data-cites="TheColonial">[@TheColonial]</span>[]</p>
<p><span class="citation" data-cites="TheColonial">[@TheColonial]</span>: https://twitter.com/TheColonial [WinInet]: https://msdn.microsoft.com/en-us/library/windows/desktop/aa383630%28v=vs.85%29.aspx [WinHTTP]: https://msdn.microsoft.com/en-us/library/windows/desktop/aa382925%28v=vs.85%29.aspx [winhttp_wininet]: https://msdn.microsoft.com/en-us/library/windows/desktop/hh227298%28v=vs.85%29.aspx [Paranoid Mode]: https://github.com/rapid7/metasploit-framework/wiki/Meterpreter-Paranoid-Mode [OJ]: https://github.com/OJ</p>

</div> <!-- article-content -->

<div id="footer-nav-bar">
<div><a href="Meterpreter-Paranoid-Mode.html">←prev</a></div><div class="nav-bar-push"><a href="Python-Extension.html">next→</a></div>
</div>

</div> <!-- article-box -->

</div> <!-- trunk-box -->

<div id="my-footer">
<p>Copyright <a href="https://metasploit.com/">Metasploit</a>, 2020</p>
<p><a href="https://join.slack.com/t/metasploit/shared_invite/enQtOTMxMjg5ODY3NDYxLTYyZTVlNDM1ZTI3ZGQ0YTQ0NmI1YjgxMGEwYzFhOWNiZWQ4NDNmNTE1MWNiYzJhMzgwMGY0ZWY2NTY0MjA2M2I">Slack team - metasploit.slack.com</a></p>
<p><a href="https://twitter.com/metasploit">#twitter handle - @metasploit</a></p>
<p><a href="mailto:msfdev@metasploit.com">development questions - msfdev [ @ ] metasploit.com</a></p>
<p> This site is built with <a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>, <a href="https://lunrjs.com/">Lunr</a>, and <a href="https://github.com/BLE-LTER/Lunr-Index-and-Search-for-Static-Sites">BLE-LTER</a>.<br/>
<a href="The-ins-and-outs-of-HTTP-and-HTTPS-communications-in-Meterpreter-and-Metasploit-Stagers.md">Pandoc-Markdown source for this page</a><br/>
(Docs processed by
<a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>.)
</div> <!-- my-footer -->

</div> <!-- main-outer-box -->

</body>
</html>
