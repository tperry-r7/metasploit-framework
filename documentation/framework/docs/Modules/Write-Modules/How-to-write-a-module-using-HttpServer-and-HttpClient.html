<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Metasploit Version 4,5" />
  <title>How to write a module using HTTPServer and HTTPClient</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../styles.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,300;1,400&display=swap" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>

<div id="main-outer-box">

<nav class="right">
  <ul>
    <li style="display: inline;"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/documentation/modules" target="_blank">Module Docs</a></li>
    <li style="display: inline;"><a href="https://rapid7.github.io/metasploit-framework/api/" target="_blank">API</a></li>
    <li style="display: inline;"><a href="https://github.com/rapid7/metasploit-framework" target="_blank">Metasploit GitHub</a></li>
     <li style="display: inline;"><a href="../../search.html">Search</a></li>
  </ul>
</nav>

<div id="my-header">
  <a href="{{path-to-index}}">Metasploit Framework</a>
</div>

<div id="trunk-box">

<div id="nav-box">
<p>Contents:</p>
<ul>
<li>Getting-Started/
<ul>
<li><a href="../.././Getting-Started/Installing-Metasploit.html">Installing Metasploit</a></li>
<li><a href="../.././Getting-Started/setting-up-metasploit-dev-enviroment.html">Setting up a Metasploit Developer Environment</a></li>
<li>Contributing/
<ul>
<li><a href="../.././Getting-Started/Contributing/Code-Of-Conduct.html">Contributor Code of Conduct</a></li>
<li><a href="../.././Getting-Started/Contributing/Contributing-to-Metasploit.html">Contributing to Metasploit</a></li>
<li><a href="../.././Getting-Started/Contributing/Guidelines-for-Accepting-Modules-and-Enhancements.html">Guidelines for accepting modules and enhancements</a></li>
<li><a href="../.././Getting-Started/Contributing/Adding-Release-Notes-to-PRs.html">Adding release notes to PRs</a></li>
<li><a href="../.././Getting-Started/Contributing/Landing-Pull-Requests.html">Landing pull requests</a></li>
<li><a href="../.././Getting-Started/Contributing/Keeping-in-sync-with-rapid7-master.html">Keep in sync with master</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-add-and-update-gems-in-metasploit-framework.html">How to add and update gems</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-deprecate-a-Metasploit-module.html">How to deprecate a Metasploit module</a></li>
<li><a href="../.././Getting-Started/Contributing/Rolling-back-merges.html">Roll back merges</a></li>
<li><a href="../.././Getting-Started/Contributing/Style-Tips.html">Style Tips</a></li>
<li><a href="../.././Getting-Started/Contributing/Reporting-a-Bug.html">Metasploit Bug Reporting</a></li>
<li><a href="../.././Getting-Started/Contributing/markdown-cheat-sheet.html">Markdown Cheat Sheet</a></li>
</ul></li>
<li>Kali-Linux/
<ul>
<li><a href="../.././Getting-Started/Kali-Linux/How-to-get-Oracle-Support-working-with-Kali-Linux.html">Use Oracle support with Kali Linux</a></li>
</ul></li>
<li><a href="../.././Getting-Started/Contact.html">Contact</a></li>
</ul></li>
<li>Internals/
<ul>
<li><a href="../.././Internals/workspaces.html">Workspaces</a></li>
</ul></li>
<li>Modules/
<ul>
<li><a href="../.././Modules/How-to-use-a-Metasploit-module-appropriately.html">Properly use a module</a></li>
<li><a href="../.././Modules/Module-Documentation.html">Module documentation</a></li>
<li><a href="../.././Modules/Handling-Module-Failures-with-fail_with.html">Handing modules failures with <code>fail_with</code></a></li>
<li><a href="../.././Modules/Running-Private-Modules.html">Run private modules</a></li>
<li><a href="../.././Modules/How-to-do-reporting-or-store-data-in-module-development.html">How to do reporting and store data during module development</a></li>
<li><a href="../.././Modules/Using-ReflectiveDll-Injection.html">Using the ReflectiveDll loader in a Metasploit module</a></li>
<li>Write-Modules/
<ul>
<li><strong>How to write a module using HTTPServer and HTTPClient</strong></li>
<li><a href="Writing-External-Metasploit-Modules.html">Writing External Metasploit Modules</a></li>
<li><a href="get-started-writing-auxillary-module.html">Get started with writing an auxiliary module</a></li>
<li><a href="How-to-write-a-HTTP-LoginScanner-Module.html">How to write a HTTP LoginScanner Module</a></li>
<li><a href="Writing-External-Python-Modules.html">Writing Python Modules for Metasploit</a></li>
<li><a href="get-started-writing-post-module.html">Get started with writing a post module</a></li>
<li><a href="Writing-External-GoLang-Modules.html">Writing external GoLang modules</a></li>
<li><a href="login-scanner.html">Create a Login Scanner Module</a></li>
<li><a href="http-login-scanner.html">How to write a HTTP LoginScanner Module</a></li>
</ul></li>
<li><a href="../.././Modules/module-reference-identifiers.html">Reference Identifiers</a></li>
</ul></li>
<li>Exploits/
<ul>
<li><a href="../.././Exploits/use-exploits.html">Use exploits</a></li>
<li><a href="../.././Exploits/Information-About-Unmet-Browser-Exploit-Requirements.html">Unmet browser exploit requirements</a></li>
<li><a href="../.././Exploits/How-to-use-Powershell-in-an-exploit.html">Add PowerShell mixin to an exploit</a></li>
<li><a href="../.././Exploits/How-to-clean-up-files-using-FileDropper.html">How to clean up files using FileDropper</a></li>
<li><a href="../.././Exploits/How-to-use-PhpEXE-to-exploit-an-arbitrary-file-upload-bug.html">PhpEXE arbitrary file upload</a></li>
<li><a href="../.././Exploits/How-to-use-Railgun-for-Windows-post-exploitation.html">Use Railgun for Windows</a></li>
<li><a href="../.././Exploits/How-to-use-command-stagers.html">Use command stagers</a></li>
<li><a href="../.././Exploits/exploit-ranking.html">Exploit Ranking</a></li>
<li>Write-Exploits/
<ul>
<li><a href="../.././Exploits/Write-Exploits/writing-exploits.html">Get Started Writing an Exploit</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows.html">Write a privilege attack with WbemExec</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit.html">How to use the FILEFORMAT mixin</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-write-a-browser-exploit-using-HttpServer.html">How to write a browser exploit using HTTP Server</a></li>
<li><a href="../.././Exploits/Write-Exploits/How-to-write-a-browser-exploit-using-BrowserExploitServer.html">Write a browser exploit with BrowserExploitServer</a></li>
</ul></li>
</ul></li>
<li>Payloads/
<ul>
<li><a href="../.././Payloads/how-payloads-work.html">How Payloads Work</a></li>
<li><a href="../.././Payloads/payload-debugging.html">Payload Debugging</a></li>
<li><a href="../.././Payloads/Payload-UUID.html">Payload UUID</a></li>
<li>Meterpreter/
<ul>
<li><a href="../.././Payloads/Meterpreter/about-meterpreter.html">About Meterpreter</a></li>
<li><a href="../.././Payloads/Meterpreter/meterpreter-configuration.html">Meterpreter Configuration</a></li>
<li><a href="../.././Payloads/Meterpreter/transport-control.html">Transport Control</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Reliable-Network-Communication.html">Reliable Network Communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Unicode-Support.html">Unicode Support</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-HTTP-Communication.html">Meterpreter HTTP communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Sleep-Control.html">Sleep Control</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Paranoid-Mode.html">Paranoid Mode</a></li>
<li><a href="../.././Payloads/Meterpreter/The-ins-and-outs-of-HTTP-and-HTTPS-communications-in-Meterpreter-and-Metasploit-Stagers.html">HTTP and HTTPS communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Python-Extension.html">Python Extension</a></li>
</ul></li>
<li>msfvenom/
<ul>
<li><a href="../.././Payloads/msfvenom/How-to-use-msfvenom.html">How to use msfvenom</a></li>
</ul></li>
<li>Shell/
<ul>
<li><a href="../.././Payloads/Shell/How-to-use-a-reverse-shell-in-Metasploit.html">How to use a reverse shell</a></li>
</ul></li>
</ul></li>
<li>Utilities/
<ul>
<li><a href="../.././Utilities/complier-windows-c.html">How to use Metasploit Framework Compiler Windows to compile C code</a></li>
<li><a href="../.././Utilities/oracle-support-kali-linux.html">Oracle Support working with Kali Linux</a></li>
<li><a href="../.././Utilities/How-to-zip-files-with-Msf-Util-EXE.to_zip.html">How to zip files with Msf::Util::EXE.to_zip</a></li>
<li><a href="../.././Utilities/How-to-use-the-Msf-Exploit-Remote-Tcp-mixin.html">How to use the Msf::Exploit::Remote::Tcp mixin</a></li>
</ul></li>
<li>Evasion-and-Obfuscation/
<ul>
<li><a href="../.././Evasion-and-Obfuscation/obfuscation-crandomizer.html">CRandomizer</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-obfuscate-JavaScript-in-Metasploit.html">Obfuscate JavaScript</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-use-Metasploit-Framework-Obfuscation-CRandomizer.html">How to use CRandomizer</a></li>
</ul></li>
<li>API/
<ul>
<li><a href="../.././API/Metasploit-Web-Service.html">Metasploit web service</a></li>
<li><a href="../.././API/Metasploit-as-a-service.html">Metasploit as a service</a></li>
</ul></li>
<li>Debugging/
<ul>
<li><a href="../.././Debugging/How-to-log-in-Metasploit.html">Log Files in Metasploit</a></li>
<li><a href="../.././Debugging/Why-CVE-is-not-available.html">Why is a CVE Not Available?</a></li>
</ul></li>
<li><a href="../.././external-resources.html">Community Resources</a></li>
</ul>

</div>

<div id="article-box">

<div id="header-nav-bar">
<div><a href="../.././Modules/Using-ReflectiveDll-Injection.html">←prev</a></div><div class="nav-bar-push"><a href="Writing-External-Metasploit-Modules.html">next→</a></div>
</div>

<div id="article-content">
<header id="title-block-header">
<h1 class="title">How to write a module using HTTPServer and HTTPClient</h1>
<p class="author">Metasploit Version 4,5</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#todays-lesson-send-a-http-request-to-attack-the-target-machine-and-use-a-httpserver-for-payload-delivery.">Today’s lesson: Send a HTTP request to attack the target machine, and use a HttpServer for payload delivery.</a></li>
<li><a href="#related-articles">Related Articles:</a></li>
</ul>
</nav>
<p>Using multiple networking mixins in a Metasploit module is always a tricky thing to do, because most likely you will run into issues like overlapping datastore options, variables, methods, the super call is only meant for one mixin, etc. This is considered as advanced module development, and sometimes can be rather painful to figure out on your own. To improve the Metasploit development experience, we have a few examples to demonstrate common scenarios that require you to use multiple mixins to achieve exploitation.</p>
<h3 id="todays-lesson-send-a-http-request-to-attack-the-target-machine-and-use-a-httpserver-for-payload-delivery.">Today’s lesson: Send a HTTP request to attack the target machine, and use a HttpServer for payload delivery.</h3>
<p>Say you want to exploit a web server or web application. You have code execution on the box, but you need to find a way to deliver the final payload (probably an executable), and a HTTP server happens to be your option.</p>
<p>Here is how you can set it up:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1"></a></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">##</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># This module requires Metasploit: http://metasploit.com/download</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># Current source: https://github.com/rapid7/metasploit-framework</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">##</span></span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a>require <span class="st">&#39;msf/core&#39;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">class</span> <span class="dt">MetasploitModule</span> &lt; <span class="dt">Msf</span>::<span class="dt">Exploit</span>::<span class="dt">Remote</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="dt">Rank</span> = <span class="dt">NormalRanking</span></span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>  include <span class="dt">Msf</span>::<span class="dt">Exploit</span>::<span class="dt">Remote</span>::<span class="dt">HttpClient</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>  include <span class="dt">Msf</span>::<span class="dt">Exploit</span>::<span class="dt">Remote</span>::<span class="dt">HttpServer</span>::<span class="dt">HTML</span></span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="kw">def</span> initialize(info={})</span>
<span id="cb1-16"><a href="#cb1-16"></a>    <span class="dv">super</span>(update_info(info,</span>
<span id="cb1-17"><a href="#cb1-17"></a>      <span class="st">&#39;Name&#39;</span>           =&gt; <span class="st">&quot;HttpClient and HttpServer Example&quot;</span>,</span>
<span id="cb1-18"><a href="#cb1-18"></a>      <span class="st">&#39;Description&#39;</span>    =&gt;<span class="ot"> %q{</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="st">        This demonstrates how to use two mixins (HttpClient and HttpServer) at the same time,</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="st">        but this allows the HttpServer to terminate after a delay.</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="st">      </span><span class="ot">}</span>,</span>
<span id="cb1-22"><a href="#cb1-22"></a>      <span class="st">&#39;License&#39;</span>        =&gt; <span class="dt">MSF_LICENSE</span>,</span>
<span id="cb1-23"><a href="#cb1-23"></a>      <span class="st">&#39;Author&#39;</span>         =&gt; [ <span class="st">&#39;sinn3r&#39;</span> ],</span>
<span id="cb1-24"><a href="#cb1-24"></a>      <span class="st">&#39;References&#39;</span>     =&gt;</span>
<span id="cb1-25"><a href="#cb1-25"></a>        [</span>
<span id="cb1-26"><a href="#cb1-26"></a>          [<span class="st">&#39;URL&#39;</span>, <span class="st">&#39;http://metasploit.com&#39;</span>]</span>
<span id="cb1-27"><a href="#cb1-27"></a>        ],</span>
<span id="cb1-28"><a href="#cb1-28"></a>      <span class="st">&#39;Payload&#39;</span>        =&gt; { <span class="st">&#39;BadChars&#39;</span> =&gt; <span class="st">&quot;\x00&quot;</span> },</span>
<span id="cb1-29"><a href="#cb1-29"></a>      <span class="st">&#39;Platform&#39;</span>       =&gt; <span class="st">&#39;win&#39;</span>,</span>
<span id="cb1-30"><a href="#cb1-30"></a>      <span class="st">&#39;Targets&#39;</span>        =&gt;</span>
<span id="cb1-31"><a href="#cb1-31"></a>        [</span>
<span id="cb1-32"><a href="#cb1-32"></a>          [ <span class="st">&#39;Automatic&#39;</span>, {} ],</span>
<span id="cb1-33"><a href="#cb1-33"></a>        ],</span>
<span id="cb1-34"><a href="#cb1-34"></a>      <span class="st">&#39;Privileged&#39;</span>     =&gt; <span class="dv">false</span>,</span>
<span id="cb1-35"><a href="#cb1-35"></a>      <span class="st">&#39;DisclosureDate&#39;</span> =&gt; <span class="st">&quot;Dec 09 2013&quot;</span>,</span>
<span id="cb1-36"><a href="#cb1-36"></a>      <span class="st">&#39;DefaultTarget&#39;</span>  =&gt; <span class="dv">0</span>))</span>
<span id="cb1-37"><a href="#cb1-37"></a></span>
<span id="cb1-38"><a href="#cb1-38"></a>      register_options(</span>
<span id="cb1-39"><a href="#cb1-39"></a>        [</span>
<span id="cb1-40"><a href="#cb1-40"></a>          <span class="dt">OptString</span>.new(<span class="st">&#39;TARGETURI&#39;</span>, [<span class="dv">true</span>, <span class="st">&#39;The path to some web application&#39;</span>, <span class="ch">&#39;/&#39;</span>]),</span>
<span id="cb1-41"><a href="#cb1-41"></a>          <span class="dt">OptInt</span>.new(<span class="st">&#39;HTTPDELAY&#39;</span>,    [<span class="dv">false</span>, <span class="st">&#39;Number of seconds the web server will wait before termination&#39;</span>, <span class="dv">10</span>])</span>
<span id="cb1-42"><a href="#cb1-42"></a>        ], <span class="dv">self</span>.class)</span>
<span id="cb1-43"><a href="#cb1-43"></a>  <span class="kw">end</span></span>
<span id="cb1-44"><a href="#cb1-44"></a></span>
<span id="cb1-45"><a href="#cb1-45"></a>  <span class="kw">def</span> on_request_uri(cli, req)</span>
<span id="cb1-46"><a href="#cb1-46"></a>    print_status(<span class="st">&quot;</span><span class="ot">#{</span>peer<span class="ot">}</span><span class="st"> - Payload request received: </span><span class="ot">#{</span>req.uri<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb1-47"><a href="#cb1-47"></a>    send_response(cli, <span class="st">&#39;You get this, I own you&#39;</span>)</span>
<span id="cb1-48"><a href="#cb1-48"></a>  <span class="kw">end</span></span>
<span id="cb1-49"><a href="#cb1-49"></a></span>
<span id="cb1-50"><a href="#cb1-50"></a>  <span class="kw">def</span> primer</span>
<span id="cb1-51"><a href="#cb1-51"></a>    print_status(<span class="st">&quot;Sending a malicious request to </span><span class="ot">#{</span>target_uri.path<span class="ot">}</span><span class="st">&quot;</span>)</span>
<span id="cb1-52"><a href="#cb1-52"></a>    send_request_cgi({<span class="st">&#39;uri&#39;</span>=&gt;normalize_uri(target_uri.path)})</span>
<span id="cb1-53"><a href="#cb1-53"></a>  <span class="kw">end</span></span>
<span id="cb1-54"><a href="#cb1-54"></a></span>
<span id="cb1-55"><a href="#cb1-55"></a>  <span class="kw">def</span> exploit</span>
<span id="cb1-56"><a href="#cb1-56"></a>    <span class="kw">begin</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>      <span class="dt">Timeout</span>.timeout(datastore[<span class="st">&#39;HTTPDELAY&#39;</span>]) { <span class="dv">super</span> }</span>
<span id="cb1-58"><a href="#cb1-58"></a>    <span class="kw">rescue</span> <span class="dt">Timeout</span>::<span class="dt">Error</span></span>
<span id="cb1-59"><a href="#cb1-59"></a>      <span class="co"># When the server stops due to our timeout, this is raised</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>    <span class="kw">end</span></span>
<span id="cb1-61"><a href="#cb1-61"></a>  <span class="kw">end</span></span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="kw">end</span></span></code></pre></div>
<p>Here’s what happens when you run the above example:</p>
<ol type="1">
<li>The super call wrapped in the Timeout block will start the web server.</li>
<li>Before the web server is in the infinite loop state, the primer() method is called, which is where you send your malicious requests to get code execution.</li>
<li>Your HttpServer serves the final payload upon request.</li>
<li>After 10 seconds, the module raises a Timeout exception. The web server finally terminates.</li>
</ol>
<p>In case you’re wondering why the web server must terminate after a period of time, this is because if the module fails to gain code execution on the target machine, obviously it will never ask your web server for the malicious payload, therefore there is no point to keeping it alive forever. Typically it shouldn’t take a very long time to get a payload request, either, so we keep the timeout short.</p>
<p>The output for the above example should look something like this:</p>
<pre><code>msf exploit(test) &gt; run
[*] Exploit running as background job.

[*] Started reverse handler on 10.0.1.76:4444 
[*] Using URL: http://0.0.0.0:8080/SUuv1qjZbCibL80
[*]  Local IP: http://10.0.1.76:8080/SUuv1qjZbCibL80
[*] Server started.
[*] Sending a malicious request to /
msf exploit(test) &gt;
[*] 10.0.1.76        test - 10.0.1.76:8181 - Payload request received: /SUuv1qjZbCibL80
[*] Server stopped.

msf exploit(test) &gt;</code></pre>
<h3 id="related-articles">Related Articles:</h3>
<ul>
<li>https://github.com/rapid7/metasploit-framework/wiki/How-to-Send-an-HTTP-Request-Using-HTTPClient</li>
<li>https://github.com/rapid7/metasploit-framework/wiki/How-to-write-a-browser-exploit-using-HttpServer</li>
<li>https://community.rapid7.com/community/metasploit/blog/2012/12/17/metasploit-hooks</li>
</ul>

</div> <!-- article-content -->

<div id="footer-nav-bar">
<div><a href="../.././Modules/Using-ReflectiveDll-Injection.html">←prev</a></div><div class="nav-bar-push"><a href="Writing-External-Metasploit-Modules.html">next→</a></div>
</div>

</div> <!-- article-box -->

</div> <!-- trunk-box -->

<div id="my-footer">
<p>Copyright <a href="https://metasploit.com/">Metasploit</a>, 2020</p>
<p><a href="https://join.slack.com/t/metasploit/shared_invite/enQtOTMxMjg5ODY3NDYxLTYyZTVlNDM1ZTI3ZGQ0YTQ0NmI1YjgxMGEwYzFhOWNiZWQ4NDNmNTE1MWNiYzJhMzgwMGY0ZWY2NTY0MjA2M2I">Slack team - metasploit.slack.com</a></p>
<p><a href="https://twitter.com/metasploit">#twitter handle - @metasploit</a></p>
<p><a href="mailto:msfdev@metasploit.com">development questions - msfdev [ @ ] metasploit.com</a></p>
<p> This site is built with <a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>, <a href="https://lunrjs.com/">Lunr</a>, and <a href="https://github.com/BLE-LTER/Lunr-Index-and-Search-for-Static-Sites">BLE-LTER</a>.<br/>
<a href="How-to-write-a-module-using-HttpServer-and-HttpClient.md">Pandoc-Markdown source for this page</a><br/>
(Docs processed by
<a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>.)
</div> <!-- my-footer -->

</div> <!-- main-outer-box -->

</body>
</html>
