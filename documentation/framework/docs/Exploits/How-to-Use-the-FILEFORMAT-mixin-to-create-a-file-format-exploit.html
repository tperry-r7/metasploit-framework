<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Metasploit Versions 4,5" />
  <title>How to use the FILEFORMAT mixin</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../styles.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,300;1,400&display=swap" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <nav class="right">
    <ul>
      <li style="display: inline;"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/documentation/modules" target="_blank">Module Docs</a></li>
      <li style="display: inline;"><a href="https://rapid7.github.io/metasploit-framework/api/" target="_blank">API</a></li>
      <li style="display: inline;"><a href="https://github.com/rapid7/metasploit-framework" target="_blank">Metasploit GitHub</a></li>
    </ul>
  </nav>
</head>
<body>

<div id="main-outer-box">

<div id="my-header">
  <a href="../../index.html">Metasploit Framework</a>
</div>

<div id="trunk-box">

<div id="nav-box">
<p>Contents:</p>
<ul>
<li>Getting-Started/
<ul>
<li><a href="../.././Getting-Started/setting-up-metasploit-dev-enviroment.html">Setting up a Metasploit Developer Environment</a></li>
<li>Contributing/
<ul>
<li><a href="../.././Getting-Started/Contributing/Code-Of-Conduct.html">Contributor Code of Conduct</a></li>
<li><a href="../.././Getting-Started/Contributing/Contributing-to-Metasploit.html">Contributing to Metasploit</a></li>
<li><a href="../.././Getting-Started/Contributing/Guidelines-for-Accepting-Modules-and-Enhancements.html">Guidelines for accepting modules and enhancements</a></li>
<li><a href="../.././Getting-Started/Contributing/Adding-Release-Notes-to-PRs.html">Adding release notes to PRs</a></li>
<li><a href="../.././Getting-Started/Contributing/Landing-Pull-Requests.html">Landing pull requests</a></li>
<li><a href="../.././Getting-Started/Contributing/Keeping-in-sync-with-rapid7-master.html">Keep in sync with master</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-add-and-update-gems-in-metasploit-framework.html">How to add and update gems</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-deprecate-a-Metasploit-module.html">How to deprecate a Metasploit module</a></li>
<li><a href="../.././Getting-Started/Contributing/Rolling-back-merges.html">Roll back merges</a></li>
<li><a href="../.././Getting-Started/Contributing/Style-Tips.html">Style Tips</a></li>
<li><a href="../.././Getting-Started/Contributing/Reporting-a-Bug.html">Metasploit Bug Reporting</a></li>
<li><a href="../.././Getting-Started/Contributing/markdown-cheat-sheet.html">Markdown Cheat Sheet</a></li>
</ul></li>
<li>Kali-Linux/
<ul>
<li><a href="../.././Getting-Started/Kali-Linux/How-to-get-Oracle-Support-working-with-Kali-Linux.html">Use Oracle support with Kali Linux</a></li>
</ul></li>
<li><a href="../.././Getting-Started/Contact.html">Contact</a></li>
</ul></li>
<li>Modules/
<ul>
<li><a href="../.././Modules/How-to-use-a-Metasploit-module-appropriately.html">Properly use a module</a></li>
<li><a href="../.././Modules/Module-Documentation.html">Module documentation</a></li>
<li><a href="../.././Modules/Module-Reference-Identifiers.html">Reference Identifiers</a></li>
<li><a href="../.././Modules/Handling-Module-Failures-with-fail_with.html">Handing modules failures with <code>fail_with</code></a></li>
<li><a href="../.././Modules/Running-Private-Modules.html">Run private modules</a></li>
<li><a href="../.././Modules/http-login-scanner.html">How to write a HTTP LoginScanner Module</a></li>
<li><a href="../.././Modules/How-to-do-reporting-or-store-data-in-module-development.html">How to do reporting and store data during module development</a></li>
<li><a href="../.././Modules/login-scanner.html">Create a Login Scanner Module</a></li>
<li><a href="../.././Modules/Using-ReflectiveDll-Injection.html">Using the ReflectiveDll loader in a Metasploit module</a></li>
<li>Write-Modules/
<ul>
<li><a href="../.././Modules/Write-Modules/How-to-write-a-module-using-HttpServer-and-HttpClient.html">How to write a module using HTTPServer and HTTPClient</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-Metasploit-Modules.html">Writing External Metasploit Modules</a></li>
<li><a href="../.././Modules/Write-Modules/get-started-writing-auxillary-module.html">Get started with writing an auxiliary module</a></li>
<li><a href="../.././Modules/Write-Modules/How-to-write-a-HTTP-LoginScanner-Module.html">How to write a HTTP LoginScanner Module</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-Python-Modules.html">Writing Python Modules for Metasploit</a></li>
<li><a href="../.././Modules/Write-Modules/get-started-writing-post-module.html">Get started with writing a post module</a></li>
<li><a href="../.././Modules/Write-Modules/Writing-External-GoLang-Modules.html">Writing external GoLang modules</a></li>
</ul></li>
</ul></li>
<li>Exploits/
<ul>
<li><a href="../.././Exploits/writing-exploits.html">Get Started Writing an Exploit</a></li>
<li><a href="../.././Exploits/exploit-ranking.html">Exploit Ranking</a></li>
<li><a href="../.././Exploits/Information-About-Unmet-Browser-Exploit-Requirements.html">Unmet browser exploit requirements</a></li>
<li>How-To/
<ul>
<li><a href="How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows.html">Write a privledge attack with WbemExec</a></li>
<li><strong>How to use the FILEFORMAT mixin</strong></li>
<li><a href="How-to-write-a-browser-exploit-using-HttpServer.html">How to write a browser exploit using HTTP Server</a></li>
<li><a href="How-to-use-Powershell-in-an-exploit.html">Add PowerShell mixin to an exploit</a></li>
<li><a href="How-to-clean-up-files-using-FileDropper.html">How to clean up files using FileDropper</a></li>
<li><a href="How-to-use-PhpEXE-to-exploit-an-arbitrary-file-upload-bug.html">PhpEXE arbitrary file upload</a></li>
<li><a href="How-to-use-Railgun-for-Windows-post-exploitation.html">Use Railgun for Windows</a></li>
<li><a href="How-to-write-a-browser-exploit-using-BrowserExploitServer.html">Write a browser exploit with BrowserExploitServer</a></li>
<li><a href="How-to-use-command-stagers.html">Use command stagers</a></li>
</ul></li>
</ul></li>
<li>Payloads/
<ul>
<li><a href="../.././Payloads/payload-debugging.html">Payload Debugging</a></li>
<li><a href="../.././Payloads/how-payloads-work.html">How Payloads Work</a></li>
<li>Meterpreter/
<ul>
<li><a href="../.././Payloads/Meterpreter/debugging-dead-sessions.html">Debugging Dead Meterpreter Sessions</a></li>
<li><a href="../.././Payloads/Meterpreter/about-meterpreter.html">About Meterpreter</a></li>
<li><a href="../.././Payloads/Meterpreter/meterpreter-configuration.html">Meterpreter Configuration</a></li>
<li><a href="../.././Payloads/Meterpreter/transport-control.html">Transport Control</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter.html">About Meterpreter</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Reliable-Network-Communication.html">Reliable Network Communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Unicode-Support.html">Unicode Support</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-HTTP-Communication.html">Meterpreter HTTP communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Sleep-Control.html">Sleep Control</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Paranoid-Mode.html">Paranoid Mode</a></li>
<li><a href="../.././Payloads/Meterpreter/The-ins-and-outs-of-HTTP-and-HTTPS-communications-in-Meterpreter-and-Metasploit-Stagers.html">HTTP and HTTPS communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Python-Extension.html">Python Extension</a></li>
</ul></li>
<li>msfvenom/
<ul>
<li><a href="../.././Payloads/msfvenom/How-to-use-msfvenom.html">How to use msfvenom</a></li>
</ul></li>
<li>Shell/
<ul>
<li><a href="../.././Payloads/Shell/How-to-use-a-reverse-shell-in-Metasploit.html">How to use a reverse shell</a></li>
</ul></li>
<li><a href="../.././Payloads/Payload-UUID.html">Payload UUID</a></li>
</ul></li>
<li>Utilities/
<ul>
<li><a href="../.././Utilities/complier-windows-c.html">How to use Metasploit Framework Compiler Windows to compile C code</a></li>
<li><a href="../.././Utilities/oracle-support-kali-linux.html">Oracle Support working with Kali Linux</a></li>
<li><a href="../.././Utilities/How-to-zip-files-with-Msf-Util-EXE.to_zip.html">How to zip files with Msf::Util::EXE.to_zip</a></li>
<li><a href="../.././Utilities/How-to-use-the-Msf-Exploit-Remote-Tcp-mixin.html">How to use the Msf::Exploit::Remote::Tcp mixin</a></li>
</ul></li>
<li>Evasion-and-Obfuscation/
<ul>
<li><a href="../.././Evasion-and-Obfuscation/obfuscation-crandomizer.html">CRandomizer</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-obfuscate-JavaScript-in-Metasploit.html">Obfuscate JavaScript</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-use-Metasploit-Framework-Obfuscation-CRandomizer.html">How to use Metasploit::Framework::Obfuscation::CRandomizer</a></li>
</ul></li>
<li>API/
<ul>
<li><a href="../.././API/Metasploit-Web-Service.html">Metasploit web service</a></li>
</ul></li>
<li>Debugging/
<ul>
<li><a href="../.././Debugging/How-to-log-in-Metasploit.html">Log Files in Metasploit</a></li>
<li><a href="../.././Debugging/Why-CVE-is-not-available.html">Why is a CVE Not Available?</a></li>
</ul></li>
</ul>

</div>

<div id="article-box">

<div id="header-nav-bar">
<div><a href="How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows.html">←prev</a></div><div class="nav-bar-push"><a href="How-to-write-a-browser-exploit-using-HttpServer.html">next→</a></div>
</div>

<div id="article-content">
<header id="title-block-header">
<h1 class="title">How to use the FILEFORMAT mixin</h1>
<p class="author">Metasploit Versions 4,5</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#usage-for-file_create">Usage for file_create</a></li>
<li><a href="#custom-filename">Custom filename</a></li>
<li><a href="#fixed-filename">Fixed filename</a></li>
<li><a href="#references">References</a></li>
</ul>
</nav>
<p><code>Msf::Exploit::FILEFORMAT</code> is the mixin to use to create a file format exploit. There actually isn’t much in the mixin, but the most important method is this: <code>file_create</code>:</p>
<h3 id="usage-for-file_create">Usage for file_create</h3>
<p>As the name implies, the <code>file_create</code> method allows you to create a file. You should be using this method because it does more than just writing data to disk. One of the important things it does is it will report the file creation to the database in the format of <code>#{ltype}.localpath</code>, and the file will always be written to Metasploit’s local directory defined in <code>Msf::Config.local_directory</code> (by default this path is <code>~/.msf4/local</code>), which keep files nice and organized.</p>
<p>To use the mixin, first include <code>Msf::Exploit::FILEFORMAT</code> under the scope of your <code>Metasploit3</code> class:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1"></a>include <span class="dt">Msf</span>::<span class="dt">Exploit</span>::<span class="dt">FILEFORMAT</span></span></code></pre></div>
<p>And here’s an example of using <code>file_create</code> to build an imaginary exploit:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># This is my imaginary exploit</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>buf = <span class="st">&quot;&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>buf &lt;&lt; <span class="st">&quot;A&quot;</span> * <span class="dv">1024</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>buf &lt;&lt; [<span class="bn">0x40201f01</span>].pack(<span class="st">&quot;V&quot;</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a>buf &lt;&lt; <span class="st">&quot;\x90&quot;</span> * <span class="dv">10</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>buf &lt;&lt; payload.encoded</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a>file_create(buf)</span></code></pre></div>
<h3 id="custom-filename">Custom filename</h3>
<p>The <code>Msf::Exploit::FILENAME</code> mixin by default has a registered <code>FILENAME</code> datastore option, and it is actually optional. If there’s no filename provided, the mixin will set the name in this format: <code>"exploit.fileformat.#{self.shortname}"</code>, where <code>self.shortname</code> means the shorter version of the module name.</p>
<p>If you wish to set a default one (but still changeable by the user), then you simply register it again in the module, like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb3-1"><a href="#cb3-1"></a>register_options(</span>
<span id="cb3-2"><a href="#cb3-2"></a>  [</span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="dt">OptString</span>.new(<span class="st">&#39;FILENAME&#39;</span>, [<span class="dv">true</span>, <span class="st">&#39;The malicious file name&#39;</span>,  <span class="st">&#39;msf.jpg&#39;</span>])</span>
<span id="cb3-4"><a href="#cb3-4"></a>  ], <span class="dv">self</span>.class)</span></code></pre></div>
<h3 id="fixed-filename">Fixed filename</h3>
<p>Occasionally, you might not want your user to change the filename at all. A lazy trick to do that is by modifying the <code>FILENAME</code> datastore option at runtime, but this is very much not recommended. In fact, if you do this, you will not pass <a href="https://github.com/rapid7/metasploit-framework/wiki/Guidelines-for-Accepting-Modules-and-Enhancements#module-additions">msftidy</a>. Instead, here’s how it’s done properly:</p>
<p>1 - Deregister the <code>FILENAME</code> option</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb4-1"><a href="#cb4-1"></a>deregister_options(<span class="st">&#39;FILENAME&#39;</span>)</span></code></pre></div>
<p>2 - Next, override the <code>file_format_filename</code> method, and make it return the filename you want:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">def</span> file_format_filename</span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="st">&#39;something.jpg&#39;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">end</span></span></code></pre></div>
<p>3 - Finally, please leave a note about this in the module description.</p>
<h3 id="references">References</h3>
<p>https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/fileformat.rb</p>
<p>https://github.com/rapid7/metasploit-framework/tree/master/modules/exploits/windows/local</p>

</div> <!-- article-content -->

<div id="footer-nav-bar">
<div><a href="How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows.html">←prev</a></div><div class="nav-bar-push"><a href="How-to-write-a-browser-exploit-using-HttpServer.html">next→</a></div>
</div>

</div> <!-- article-box -->

</div> <!-- trunk-box -->

<div id="my-footer">
<p>Copyright <a href="https://metasploit.com/">Metasploit</a>, 2020</p>
<p><a href="https://join.slack.com/t/metasploit/shared_invite/enQtOTMxMjg5ODY3NDYxLTYyZTVlNDM1ZTI3ZGQ0YTQ0NmI1YjgxMGEwYzFhOWNiZWQ4NDNmNTE1MWNiYzJhMzgwMGY0ZWY2NTY0MjA2M2I">Slack team - metasploit.slack.com</a></p>
<p><a href="https://twitter.com/metasploit">#twitter handle - @metasploit</a></p>
<p><a href="mailto:msfdev@metasploit.com">development questions - msfdev [ @ ] metasploit.com</a></p><br/>
<a href="How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit.md">Pandoc-Markdown source for this page</a><br/>
(Docs processed by
<a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>.)
</div> <!-- my-footer -->

</div> <!-- main-outer-box -->

</body>
</html>
