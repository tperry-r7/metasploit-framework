<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Writing Python Modules for Metasploit</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../styles.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,300;1,400&display=swap" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <nav class="right">
    <ul>
      <li style="display: inline;"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/documentation/modules" target="_blank">Module Docs</a></li>
      <li style="display: inline;"><a href="https://rapid7.github.io/metasploit-framework/api/" target="_blank">API</a></li>
      <li style="display: inline;"><a href="https://github.com/rapid7/metasploit-framework" target="_blank">Metasploit GitHub</a></li>
    </ul>
  </nav>
</head>
<body>

<div id="main-outer-box">

<div id="my-header">
  <a href="../../index.html">Metasploit Framework</a>
</div>

<div id="trunk-box">

<div id="nav-box">
<p>Contents:</p>
<ul>
<li><a href="../.././markdown-cheat-sheet.html">Markdown Cheat Sheet</a></li>
<li>Getting-Started/
<ul>
<li><a href="../.././Getting-Started/setting-up-metasploit-dev-enviroment.html">Setting up a Metasploit Developer Environment</a></li>
<li><a href="../.././Getting-Started/Contact.html">Contact</a></li>
<li>Contributing/
<ul>
<li><a href="../.././Getting-Started/Contributing/Committer-Keys.html">Committer Keys</a></li>
<li><a href="../.././Getting-Started/Contributing/Code-Of-Conduct.html">Contributor Code of Conduct</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-add-and-update-gems-in-metasploit-framework.html">How to add and update gems</a></li>
<li><a href="../.././Getting-Started/Contributing/Committer-Rights.html">Metasploit Committers</a></li>
<li><a href="../.././Getting-Started/Contributing/Guidelines-for-Accepting-Modules-and-Enhancements.html">Guidelines for accepting modules and enhancements</a></li>
<li><a href="../.././Getting-Started/Contributing/Adding-Release-Notes-to-PRs.html">Adding release notes to PRs</a></li>
<li><a href="../.././Getting-Started/Contributing/Contributing-to-Metasploit.html">Contributing to Metasploit</a></li>
<li><a href="../.././Getting-Started/Contributing/How-to-deprecate-a-Metasploit-module.html">How to deprecate a Metasploit module</a></li>
<li><a href="../.././Getting-Started/Contributing/Keeping-in-sync-with-rapid7-master.html">Keep in sync with master</a></li>
<li><a href="../.././Getting-Started/Contributing/Landing-Pull-Requests.html">Landing pull requests</a></li>
<li><a href="../.././Getting-Started/Contributing/Reporting-a-Bug.html">Metasploit Bug Reporting</a></li>
<li><a href="../.././Getting-Started/Contributing/Rolling-back-merges.html">Roll back merges</a></li>
<li><a href="../.././Getting-Started/Contributing/Style-Tips.html">Style Tips</a></li>
</ul></li>
<li>Kali-Linux/
<ul>
<li><a href="../.././Getting-Started/Kali-Linux/How-to-get-Oracle-Support-working-with-Kali-Linux.html">Use Oracle support with Kali Linux</a></li>
</ul></li>
</ul></li>
<li>Utilities/
<ul>
<li><a href="../.././Utilities/complier-windows-c.html">How to use Metasploit Framework Compiler Windows to compile C code</a></li>
<li><a href="../.././Utilities/oracle-support-kali-linux.html">Oracle Support working with Kali Linux</a></li>
<li><a href="../.././Utilities/How-to-zip-files-with-Msf-Util-EXE.to_zip.html">How to zip files with Msf::Util::EXE.to_zip</a></li>
<li><a href="../.././Utilities/How-to-use-the-Msf-Exploit-Remote-Tcp-mixin.html">How to use the Msf::Exploit::Remote::Tcp mixin</a></li>
</ul></li>
<li>Modules/
<ul>
<li><a href="../.././Modules/get-started-writing-post-module.html">Get started with writing a post module</a></li>
<li><a href="../.././Modules/get-started-writing-auxillary-module.html">Get started with writing an auxiliary module</a></li>
<li><a href="../.././Modules/Handling-Module-Failures-with-fail_with.html">Handing modules failures with <code>fail_with</code></a></li>
<li><a href="../.././Modules/How-to-get-started-with-writing-a-post-module.html">Post module development</a></li>
<li><a href="../.././Modules/How-to-use-a-Metasploit-module-appropriately.html">Properly use a module</a></li>
<li>How-To/
<ul>
<li><a href="login-scanner.html">Create a Login Scanner Module</a></li>
<li><a href="http-login-scanner.html">How to write a HTTP LoginScanner Module</a></li>
<li><a href="How-to-do-reporting-or-store-data-in-module-development.html">How to do reporting and store data during module development</a></li>
<li><a href="How-to-write-a-module-using-HttpServer-and-HttpClient.html">How to write a module using HTTPServer and HTTPClient</a></li>
<li><a href="How-to-write-a-HTTP-LoginScanner-Module.html">How to write a HTTP LoginScanner Module</a></li>
<li><a href="Writing-External-GoLang-Modules.html">Writing external GoLang modules</a></li>
<li><strong>Writing Python Modules for Metasploit</strong></li>
<li><a href="Writing-External-Metasploit-Modules.html">Writing External Metasploit Modules</a></li>
</ul></li>
<li><a href="../.././Modules/Module-Documentation.html">Module documentation</a></li>
<li><a href="../.././Modules/Running-Private-Modules.html">Run private modules</a></li>
<li><a href="../.././Modules/Using-ReflectiveDll-Injection.html">Using the ReflectiveDll loader in a Metasploit module</a></li>
<li><a href="../.././Modules/Module-Reference-Identifiers.html">Reference Identifiers</a></li>
</ul></li>
<li>Exploits/
<ul>
<li><a href="../.././Exploits/writing-exploits.html">Get Started Writing an Exploit</a></li>
<li><a href="../.././Exploits/exploit-ranking.html">Exploit Ranking</a></li>
<li><a href="../.././Exploits/Information-About-Unmet-Browser-Exploit-Requirements.html">Unmet browser exploit requirements</a></li>
<li>How-To/
<ul>
<li><a href="../.././Exploits/How-To/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows.html">Write a privledge attack with WbemExec</a></li>
<li><a href="../.././Exploits/How-To/How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit.html">How to use the FILEFORMAT mixin</a></li>
<li><a href="../.././Exploits/How-To/How-to-write-a-browser-exploit-using-HttpServer.html">How to write a browser exploit using HTTP Server</a></li>
<li><a href="../.././Exploits/How-To/How-to-use-Powershell-in-an-exploit.html">Add PowerShell mixin to an exploit</a></li>
<li><a href="../.././Exploits/How-To/How-to-clean-up-files-using-FileDropper.html">How to clean up files using FileDropper</a></li>
<li><a href="../.././Exploits/How-To/How-to-use-PhpEXE-to-exploit-an-arbitrary-file-upload-bug.html">PhpEXE arbitrary file upload</a></li>
<li><a href="../.././Exploits/How-To/How-to-use-Railgun-for-Windows-post-exploitation.html">Use Railgun for Windows</a></li>
<li><a href="../.././Exploits/How-To/How-to-write-a-browser-exploit-using-BrowserExploitServer.html">Write a browser exploit with BrowserExploitServer</a></li>
<li><a href="../.././Exploits/How-To/How-to-use-command-stagers.html">Use command stagers</a></li>
</ul></li>
</ul></li>
<li>Debugging/
<ul>
<li><a href="../.././Debugging/How-to-log-in-Metasploit.html">Log Files in Metasploit</a></li>
<li><a href="../.././Debugging/Why-CVE-is-not-available.html">Why is a CVE Not Available?</a></li>
</ul></li>
<li>Evasion-and-Obfuscation/
<ul>
<li><a href="../.././Evasion-and-Obfuscation/obfuscation-crandomizer.html">CRandomizer</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-obfuscate-JavaScript-in-Metasploit.html">Obfuscate JavaScript</a></li>
<li><a href="../.././Evasion-and-Obfuscation/How-to-use-Metasploit-Framework-Obfuscation-CRandomizer.html">How to use Metasploit::Framework::Obfuscation::CRandomizer</a></li>
</ul></li>
<li>Payloads/
<ul>
<li><a href="../.././Payloads/payload-debugging.html">Payload Debugging</a></li>
<li><a href="../.././Payloads/how-payloads-work.html">How Payloads Work</a></li>
<li>Meterpreter/
<ul>
<li><a href="../.././Payloads/Meterpreter/debugging-dead-sessions.html">Debugging Dead Meterpreter Sessions</a></li>
<li><a href="../.././Payloads/Meterpreter/about-meterpreter.html">About Meterpreter</a></li>
<li><a href="../.././Payloads/Meterpreter/meterpreter-configuration.html">Meterpreter Configuration</a></li>
<li><a href="../.././Payloads/Meterpreter/transport-control.html">Transport Control</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter.html">About Meterpreter</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Reliable-Network-Communication.html">Reliable Network Communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Unicode-Support.html">Unicode Support</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-HTTP-Communication.html">Meterpreter HTTP communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Sleep-Control.html">Sleep Control</a></li>
<li><a href="../.././Payloads/Meterpreter/Meterpreter-Paranoid-Mode.html">Paranoid Mode</a></li>
<li><a href="../.././Payloads/Meterpreter/The-ins-and-outs-of-HTTP-and-HTTPS-communications-in-Meterpreter-and-Metasploit-Stagers.html">HTTP and HTTPS communication</a></li>
<li><a href="../.././Payloads/Meterpreter/Python-Extension.html">Python Extension</a></li>
</ul></li>
<li>msfvenom/
<ul>
<li><a href="../.././Payloads/msfvenom/How-to-use-msfvenom.html">How to use msfvenom</a></li>
</ul></li>
<li>Shell/
<ul>
<li><a href="../.././Payloads/Shell/How-to-use-a-reverse-shell-in-Metasploit.html">How to use a reverse shell</a></li>
</ul></li>
<li><a href="../.././Payloads/Payload-UUID.html">Payload UUID</a></li>
</ul></li>
<li>API/
<ul>
<li><a href="../.././API/Metasploit-Web-Service.html">Metasploit web service</a></li>
</ul></li>
</ul>

</div>

<div id="article-box">

<div id="header-nav-bar">
<div><a href="Writing-External-GoLang-Modules.html">←prev</a></div><div class="nav-bar-push"><a href="Writing-External-Metasploit-Modules.html">next→</a></div>
</div>

<div id="article-content">
<header id="title-block-header">
<h1 class="title">Writing Python Modules for Metasploit</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#python-library">Python Library</a></li>
<li><a href="#describe-yourself">Describe Yourself</a>
<ul>
<li><a href="#module-type">Module Type</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#communication">Communication</a></li>
</ul></li>
<li><a href="#full-example">Full Example</a></li>
<li><a href="#coding-with-style">Coding with Style</a></li>
<li><a href="#potentially-common-questions">(Potentially) Common Questions</a>
<ul>
<li><a href="#why-doesnt-the-module-appear-when-i-search-for-it-in-msfconsole">Why doesn’t the module appear when I search for it in msfconsole?</a></li>
<li><a href="#why-is-the-output-from-the-python-module-not-showing-up-in-msfconsole">Why is the output from the Python module not showing up in msfconsole?</a></li>
</ul></li>
<li><a href="#additional-resources">Additional Resources</a></li>
</ul>
</nav>
<p>This is an example of how to write a Python module for Metasploit Framework that uses a Python metasploit library to communicate with framework via JSON-RPC over stdin/stdout.</p>
<h2 id="python-library">Python Library</h2>
<p>The library currently supports a few function calls that can be used to report information to Metasploit Framework. The <code>metasploit</code> library can be loaded into your Python module by including the following line:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">from</span> metasploit <span class="im">import</span> module</span></code></pre></div>
<p>The location of the <a href="https://github.com/rapid7/metasploit-framework/tree/master/lib/msf/core/modules/external/python">metasploit library</a> is automatically added to the <code>PYTHONPATH</code> environment variable before the Python module is executed.</p>
<h2 id="describe-yourself">Describe Yourself</h2>
<p>Metasploit modules include information about authors of the modules, references to other sources with information about the vulnerabilities, descriptions of the modules, options, etc.</p>
<p>Python modules need to include this metadata information as well. The structure of the data is similar to modules written in Ruby. The following is an example template of metadata information:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>metadata <span class="op">=</span> {</span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="st">&#39;name&#39;</span>: <span class="st">&#39;&lt;name&gt;&#39;</span>,</span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="st">&#39;description&#39;</span>: <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="st">        &lt;description&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="st">    &#39;&#39;&#39;</span>,</span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="st">&#39;authors&#39;</span>: [</span>
<span id="cb2-7"><a href="#cb2-7"></a>        <span class="st">&#39;&lt;author&gt;&#39;</span>,</span>
<span id="cb2-8"><a href="#cb2-8"></a>        <span class="st">&#39;&lt;author&gt;&#39;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    ],</span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="st">&#39;date&#39;</span>: <span class="st">&#39;YYYY-MM-DD&#39;</span>,</span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="st">&#39;license&#39;</span>: <span class="st">&#39;&lt;license&gt;&#39;</span>,</span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="st">&#39;references&#39;</span>: [</span>
<span id="cb2-13"><a href="#cb2-13"></a>        {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;url&#39;</span>, <span class="st">&#39;ref&#39;</span>: <span class="st">&#39;&lt;url&gt;&#39;</span>},</span>
<span id="cb2-14"><a href="#cb2-14"></a>        {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;cve&#39;</span>, <span class="st">&#39;ref&#39;</span>: <span class="st">&#39;YYYY-#&#39;</span>},</span>
<span id="cb2-15"><a href="#cb2-15"></a>        {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;edb&#39;</span>, <span class="st">&#39;ref&#39;</span>: <span class="st">&#39;#&#39;</span>},</span>
<span id="cb2-16"><a href="#cb2-16"></a>        {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;aka&#39;</span>, <span class="st">&#39;ref&#39;</span>: <span class="st">&#39;&lt;name&gt;&#39;</span>}</span>
<span id="cb2-17"><a href="#cb2-17"></a>    ],</span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="st">&#39;type&#39;</span>: <span class="st">&#39;&lt;module type&gt;&#39;</span>,</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="st">&#39;options&#39;</span>: {</span>
<span id="cb2-20"><a href="#cb2-20"></a>        <span class="st">&#39;&lt;name&gt;&#39;</span>: {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;address&#39;</span>, <span class="st">&#39;description&#39;</span>: <span class="st">&#39;&lt;description&gt;&#39;</span>, <span class="st">&#39;required&#39;</span>: <span class="op">&lt;</span><span class="va">True</span><span class="op">/</span><span class="va">False</span><span class="op">&gt;</span>, <span class="st">&#39;default&#39;</span>: <span class="va">None</span>},</span>
<span id="cb2-21"><a href="#cb2-21"></a>        <span class="st">&#39;&lt;name&gt;&#39;</span>: {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;string&#39;</span>, <span class="st">&#39;description&#39;</span>: <span class="st">&#39;&lt;description&gt;&#39;</span>, <span class="st">&#39;required&#39;</span>: <span class="op">&lt;</span><span class="va">True</span><span class="op">/</span><span class="va">False</span><span class="op">&gt;</span>, <span class="st">&#39;default&#39;</span>: <span class="va">None</span>},</span>
<span id="cb2-22"><a href="#cb2-22"></a>        <span class="st">&#39;&lt;name&gt;&#39;</span>: {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;string&#39;</span>, <span class="st">&#39;description&#39;</span>: <span class="st">&#39;&lt;description&gt;&#39;</span>, <span class="st">&#39;required&#39;</span>: <span class="op">&lt;</span><span class="va">True</span><span class="op">/</span><span class="va">False</span><span class="op">&gt;</span>, <span class="st">&#39;default&#39;</span>: <span class="va">None</span>}</span>
<span id="cb2-23"><a href="#cb2-23"></a>    }</span>
<span id="cb2-24"><a href="#cb2-24"></a>}</span></code></pre></div>
<h3 id="module-type">Module Type</h3>
<p>As shown in the metadata template information, a <code>type</code> is also include for the module. The module type is used to select an ERB template, which generates a Ruby document for the module. The ERB templates can be found <a href="https://github.com/rapid7/metasploit-framework/tree/master/lib/msf/core/modules/external/templates">here</a>. The following templates are currently available:</p>
<pre><code>remote_exploit_cmd_stager
capture_server
dos
single_scanner
multi_scanner</code></pre>
<p>The <code>remote_exploit_cmd_stager</code> module type is used when writing an exploit for command execution or code injection vulnerabilities and provides the command to inject into the vulnerable code based on the <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-use-command-stagers">flavor</a> specified for the command stager.</p>
<p>The <code>capture_server</code> module type is used when a module is designed to simulate a service to capture credentials for connecting clients.</p>
<p>The <code>dos</code> module type is used when the module will send packets to a remote service that will crash the service or put it in an unusable state.</p>
<p>The <code>single_scanner</code> module type is used when creating a module to scan hosts without batching.</p>
<p>The <code>multi_scanner</code> module type is used for modules that are going to scan hosts in batches. The <code>batch_size</code> option is registered in the mutli_scanner ERB template with a default of 200.</p>
<h3 id="options">Options</h3>
<p>The <code>options</code> dictionary in the metadata are the options that will be available in msfconsole when the module is loaded. The options can be required (necessary for the module to run) or not (provide additional functionality).</p>
<h3 id="communication">Communication</h3>
<p>To pass the metadata information, as well as the starting function of your Python module, to msfconsole, use the <code>module.run()</code> function. The <code>module.run()</code> function takes two arguments, the first is the metadata and the second is the callback function to use when executing the module from msfconsole. The code snippet will look like the following:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">def</span> run(args):</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="co"># Your code here</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="cf">pass</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb4-7"><a href="#cb4-7"></a>    module.run(metadata, run)</span></code></pre></div>
<p>When msfconsole sends a <code>describe</code> request to the Python module, the metadata information is returned. When msfconsole sends a <code>run</code> request to the module, the callback function, <code>run</code> in this example, will be called with the arguments provided to msfconsole.</p>
<p>A <a href="https://github.com/rapid7/metasploit-framework/pull/9739">LogHandler</a> can be setup and used to communicate status information back to framework during execution of the Python module. Here is code snippet that uses the LogHandler:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">import</span> logging</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="im">from</span> metasploit <span class="im">import</span> module</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a>module.LogHandler.setup(msg_prefix<span class="op">=</span><span class="st">&#39;logging test: &#39;</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a>logging.info(<span class="st">&#39;info&#39;</span>)</span>
<span id="cb5-6"><a href="#cb5-6"></a>logging.error(<span class="st">&#39;error&#39;</span>)</span>
<span id="cb5-7"><a href="#cb5-7"></a>logging.warning(<span class="st">&#39;warning&#39;</span>)</span>
<span id="cb5-8"><a href="#cb5-8"></a>logging.debug(<span class="st">&#39;debug&#39;</span>)</span></code></pre></div>
<p>The <code>module.LogHandler.setup()</code> function is used the create a Handler and Formatter that will call <code>module.log()</code> with the appropriate log level.</p>
<h2 id="full-example">Full Example</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co"># standard modules</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="im">import</span> logging</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co"># extra modules</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>dependencies_missing <span class="op">=</span> <span class="va">False</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="cf">try</span>:</span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="im">import</span> requests</span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb6-12"><a href="#cb6-12"></a>    dependencies_missing <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="im">from</span> metasploit <span class="im">import</span> module</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a>metadata <span class="op">=</span> {</span>
<span id="cb6-18"><a href="#cb6-18"></a>    <span class="st">&#39;name&#39;</span>: <span class="st">&#39;Python Module Example&#39;</span>,</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="st">&#39;description&#39;</span>: <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="st">        Python communication with msfconsole.</span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="st">    &#39;&#39;&#39;</span>,</span>
<span id="cb6-22"><a href="#cb6-22"></a>    <span class="st">&#39;authors&#39;</span>: [</span>
<span id="cb6-23"><a href="#cb6-23"></a>        <span class="st">&#39;Jacob Robles&#39;</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>    ],</span>
<span id="cb6-25"><a href="#cb6-25"></a>    <span class="st">&#39;date&#39;</span>: <span class="st">&#39;2018-03-22&#39;</span>,</span>
<span id="cb6-26"><a href="#cb6-26"></a>    <span class="st">&#39;license&#39;</span>: <span class="st">&#39;MSF_LICENSE&#39;</span>,</span>
<span id="cb6-27"><a href="#cb6-27"></a>    <span class="st">&#39;references&#39;</span>: [</span>
<span id="cb6-28"><a href="#cb6-28"></a>        {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;url&#39;</span>, <span class="st">&#39;ref&#39;</span>: <span class="st">&#39;https://blog.rapid7.com/2017/12/28/regifting-python-in-metasploit/&#39;</span>},</span>
<span id="cb6-29"><a href="#cb6-29"></a>        {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;aka&#39;</span>, <span class="st">&#39;ref&#39;</span>: <span class="st">&#39;Coldstone&#39;</span>}</span>
<span id="cb6-30"><a href="#cb6-30"></a>    ],</span>
<span id="cb6-31"><a href="#cb6-31"></a>    <span class="st">&#39;type&#39;</span>: <span class="st">&#39;single_scanner&#39;</span>,</span>
<span id="cb6-32"><a href="#cb6-32"></a>    <span class="st">&#39;options&#39;</span>: {</span>
<span id="cb6-33"><a href="#cb6-33"></a>        <span class="st">&#39;targeturi&#39;</span>: {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;string&#39;</span>, <span class="st">&#39;description&#39;</span>: <span class="st">&#39;The base path&#39;</span>, <span class="st">&#39;required&#39;</span>: <span class="va">True</span>, <span class="st">&#39;default&#39;</span>: <span class="st">&#39;/&#39;</span>},</span>
<span id="cb6-34"><a href="#cb6-34"></a>        <span class="st">&#39;rhost&#39;</span>: {<span class="st">&#39;type&#39;</span>: <span class="st">&#39;address&#39;</span>, <span class="st">&#39;description&#39;</span>: <span class="st">&#39;Target address&#39;</span>, <span class="st">&#39;required&#39;</span>: <span class="va">True</span>, <span class="st">&#39;default&#39;</span>: <span class="va">None</span>}</span>
<span id="cb6-35"><a href="#cb6-35"></a>    }</span>
<span id="cb6-36"><a href="#cb6-36"></a>}</span>
<span id="cb6-37"><a href="#cb6-37"></a></span>
<span id="cb6-38"><a href="#cb6-38"></a></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="kw">def</span> run(args):</span>
<span id="cb6-40"><a href="#cb6-40"></a>    module.LogHandler.setup(msg_prefix<span class="op">=</span><span class="st">&#39;</span><span class="sc">{}</span><span class="st"> - &#39;</span>.<span class="bu">format</span>(args[<span class="st">&#39;rhost&#39;</span>]))</span>
<span id="cb6-41"><a href="#cb6-41"></a>    <span class="cf">if</span> dependencies_missing:</span>
<span id="cb6-42"><a href="#cb6-42"></a>        logging.error(<span class="st">&#39;Module dependency (requests) is missing, cannot continue&#39;</span>)</span>
<span id="cb6-43"><a href="#cb6-43"></a>        <span class="cf">return</span></span>
<span id="cb6-44"><a href="#cb6-44"></a></span>
<span id="cb6-45"><a href="#cb6-45"></a>    <span class="co"># Your code here</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>    <span class="cf">try</span>:</span>
<span id="cb6-47"><a href="#cb6-47"></a>        r <span class="op">=</span> requests.get(<span class="st">&#39;https://</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(args[<span class="st">&#39;rhost&#39;</span>], args[<span class="st">&#39;targeturi&#39;</span>]), verify<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-48"><a href="#cb6-48"></a>    <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb6-49"><a href="#cb6-49"></a>        logging.error(<span class="st">&#39;</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(e))</span>
<span id="cb6-50"><a href="#cb6-50"></a>        <span class="cf">return</span></span>
<span id="cb6-51"><a href="#cb6-51"></a></span>
<span id="cb6-52"><a href="#cb6-52"></a>    logging.info(<span class="st">&#39;</span><span class="sc">{}</span><span class="st">...&#39;</span>.<span class="bu">format</span>(r.text[<span class="dv">0</span>:<span class="dv">50</span>]))</span>
<span id="cb6-53"><a href="#cb6-53"></a></span>
<span id="cb6-54"><a href="#cb6-54"></a></span>
<span id="cb6-55"><a href="#cb6-55"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb6-56"><a href="#cb6-56"></a>    module.run(metadata, run)</span></code></pre></div>
<p>The example sends a get request to the given <code>rhost</code> and <code>targeturi</code>, then calls <code>logging.info()</code> on the result to have the output displayed in msfconsole.</p>
<h2 id="coding-with-style">Coding with Style</h2>
<p>All the Python code in Metasploit aims to be <a href="https://www.python.org/dev/peps/pep-0008/">PEP 8</a> compliant. The biggest differences coming from Metasploit’s Ruby style: * Two lines between functions (but not class methods) * Two lines between different types of code (like imports and the metadata, see above) * Four spaces for indenting</p>
<p>Some coding choices to think about when writing your module: * Prefer <code>"foo {}".format('bar')</code> over interpolation with <code>%</code> * Keep your callback methods short and readable. If it gets cluttered, break out sub-tasks into well-named functions * Variable names should be descriptive, readable, and short (<a href="http://journal.stuffwithstuff.com/2016/06/16/long-names-are-long">a guide</a>) * If you really need Python3 features in your module, use <code>#!/usr/bin/env python3</code> for the shebang * If you have a lot of legacy code in 2.7 or need a 2.7 library, use <code>#!/usr/bin/env python2.7</code> (macOS in particular does not ship with a <code>python2</code> executable by default) * If possible, have your module compatible with both and use <code>#!/usr/bin/env python</code></p>
<h2 id="potentially-common-questions">(Potentially) Common Questions</h2>
<h3 id="why-doesnt-the-module-appear-when-i-search-for-it-in-msfconsole">Why doesn’t the module appear when I search for it in msfconsole?</h3>
<p>The module may have errors and fail to load inside of msfconsole. Check the framework log file, <code>~/.msf4/logs/framework.log</code>, for error messages. Also, if the module is not marked as executable, then it will not show up when you search for it in msfconsole.</p>
<h3 id="why-is-the-output-from-the-python-module-not-showing-up-in-msfconsole">Why is the output from the Python module not showing up in msfconsole?</h3>
<p>The external modules communicate with framework via JSON-RPC. If your Python module contains <code>print</code> statements, framework may not recognize those as JSON-RPC requests. Use the <code>LogHandler</code> or <code>module.log()</code> to send status information, which will be displayed in msfconsole.</p>
<h2 id="additional-resources">Additional Resources</h2>
<p><a href="https://blog.rapid7.com/2017/12/28/regifting-python-in-metasploit/">Rapid7 Blog: Regifting Python in Metasploit</a></p>
<p><a href="https://blog.rapid7.com/2018/09/05/external-metasploit-modules-the-gift-that-keeps-on-slithering/">Rapid7 Blog: External Metasploit Modules: The Gift That Keeps On Slithering</a></p>
<p><a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/modules/external/python/">Metasploit Python library</a></p>
<p><a href="https://github.com/rapid7/metasploit-framework/tree/master/lib/msf/core/modules/external/templates">ERB Templates</a></p>

</div> <!-- article-content -->

<div id="footer-nav-bar">
<div><a href="Writing-External-GoLang-Modules.html">←prev</a></div><div class="nav-bar-push"><a href="Writing-External-Metasploit-Modules.html">next→</a></div>
</div>

</div> <!-- article-box -->

</div> <!-- trunk-box -->

<div id="my-footer">
<p>Copyright <a href="https://metasploit.com/">Metasploit</a>, 2020</p>
<p><a href="https://join.slack.com/t/metasploit/shared_invite/enQtOTMxMjg5ODY3NDYxLTYyZTVlNDM1ZTI3ZGQ0YTQ0NmI1YjgxMGEwYzFhOWNiZWQ4NDNmNTE1MWNiYzJhMzgwMGY0ZWY2NTY0MjA2M2I">Slack team - metasploit.slack.com</a></p>
<p><a href="https://twitter.com/metasploit">#twitter handle - @metasploit</a></p>
<p><a href="mailto:msfdev@metasploit.com">development questions - msfdev [ @ ] metasploit.com</a></p><br/>
<a href="Writing-External-Python-Modules.md">Pandoc-Markdown source for this page</a><br/>
(Docs processed by
<a href="http://www.unexpected-vortices.com/sw/rippledoc/index.html">Rippledoc</a>.)
</div> <!-- my-footer -->

</div> <!-- main-outer-box -->

</body>
</html>
